<!DOCTYPE html>
<html>
<head>
    <title>Feature Planning Board</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            /*
             */
            Ext.define('Rally.technicalservices.logger',{
                constructor: function(config){
                    Ext.apply(this,config);
                },
                log: function(args){
                    var output_args = [];
                    if (arguments.length === 0 ) {
                        window.console && console.log(arguments);
                        return;
                    }
                    if (arguments.length === 1 ) {
                        output_args = arguments;
                    } else {
                        var src_class = arguments[0];
                        var class_name = "";
                        if ( typeof(src_class) === "string" ) {
                            class_name = src_class;
                        } else if ( typeof src_class.getName === "function") { 
                            class_name = src_class.getName();
                        } else if (typeof src_class.self.getName === 'function'){
                            class_name = src_class.self.getName();
                        }
                        //window.console && console.log(class_name,"--",message);
                        output_args = Ext.Array.push(output_args,[class_name,"--"]);
                        output_args = Ext.Array.push(output_args,Ext.Array.slice(arguments,1));
                    }
                    window.console && console.log.apply(console,output_args);
                }
            
            });            /*
             * Modify the building of columns based on release instead of a string drop-down
             */
            
            Ext.override(Rally.ui.cardboard.CardBoard,{
            
                _buildColumnsFromModel: function() {
                    var me = this;
                    var model = this.models[0];
                    if (model) {
                        if ( this.attribute === "Release" ) { 
                            var retrievedColumns = [];
                            retrievedColumns.push({
                                
                                value: null,
                                columnHeaderConfig: {
                                    headerTpl: "{name}",
                                    headerData: {
                                        name: "Backlog"
                                    }
                                }
                            });
                            
                            var today_iso = Rally.util.DateTime.toIsoString(new Date(),false);
                            var filters = [{property:'ReleaseDate',operator:'>',value:today_iso}];
                            
                            Ext.create('Rally.data.WsapiDataStore',{
                                model:me.attribute,
                                autoLoad: true,
                                filters: filters,
                                sorters: [
                                    {
                                        property: 'ReleaseDate',
                                        direction: 'ASC'
                                    }
                                ],
                                limit: 3,
                                pageSize: 3,
                                fetch: ['Name','ReleaseStartDate','ReleaseDate','PlannedVelocity'],
                                listeners: {
                                    load: function(store,records) {
                                        Ext.Array.each(records, function(record){
                                            var start_date = Rally.util.DateTime.formatWithNoYearWithDefault(record.get('ReleaseStartDate'));
                                            var end_date = Rally.util.DateTime.formatWithNoYearWithDefault(record.get('ReleaseDate'));
                                            var planned_velocity = record.get('PlannedVelocity') || 0;
                                            
                                            retrievedColumns.push({
                                                value: record.get('_ref'),
                                                _planned_velocity: planned_velocity,
                                                columnHeaderConfig: {
                                                    headerTpl: "{name}<br/>{start_date} - {end_date}",
                                                    headerData: {
                                                        name: record.get('Name'),
                                                        start_date: start_date,
                                                        end_date: end_date,
                                                        planned_velocity: planned_velocity
                                                    }
                                                }
                                            });
                                        });
                                        this.fireEvent('columnsretrieved',this,retrievedColumns);
                                        this.columnDefinitions = [];
                                        _.map(retrievedColumns,this.addColumn,this);
                                        this._renderColumns();
                                    },
                                    scope: this
                                }
                            });
                            
                        } else {
                            var attribute = model.getField(this.attribute);
                           
                            if (attribute) {
                                attribute.getAllowedValueStore().load({
                                    callback: function(records, operation, success) {
                                        var retrievedColumns = [];
                                        _.forEach(records, function(allowedValue) {
                                            var value = allowedValue.get('StringValue');
                                            if (!value && attribute.attributeDefinition.AttributeType.toLowerCase() === 'rating') {
                                                value = "None";
                                            }
                                            if (value.toLowerCase() !== 'null') {
                                                retrievedColumns.push({
                                                    value: value,
                                                    columnHeaderConfig: {
                                                        headerTpl: value || 'None'
                                                    }
                                                });
                                            }
                                        });
                    
                                        this.fireEvent('columnsretrieved', this, retrievedColumns);
                    
                                        this.columnDefinitions = [];
                                        _.map(retrievedColumns, this.addColumn, this);
                                        this._renderColumns();
                                    },
                                    scope: this
                                });
                            }
                        }
                    }
                }
            });
            
            Ext.override(Rally.ui.cardboard.Card,{
                _setupPlugins: function() {
                    var cardContentRightPlugin = {ptype: 'rallycardcontentright'};
            
                    this.plugins.push(cardContentRightPlugin);
                    this.plugins.push({ptype: 'rallycardcontentleft'});
            
                    if (this.record.get('updatable')) {
                        if (this.editable) {
                            this.addCls('editable');
                            this.plugins.push({ptype: 'rallycardediting'});
            
                            var predicateFn = Rally.predicate.RecordPredicates.hasField('PlanEstimate');
                            if (predicateFn(this.record) && Ext.Array.contains(this.getFields(), 'PlanEstimate')) {
                                cardContentRightPlugin.showPlanEstimate = true;
                            }
            
                            if (this.enableValidationUi) {
                                this.plugins.push({ptype: 'rallycardvalidation'});
                                this.plugins.push({ptype: 'rallycardvalidationui', notificationFieldNames: ['PlanEstimate']});
                            }
                        }
            
                        if (this.showIconsAndHighlightBorder) {
                            this.plugins.push({
                                ptype: 'rallycardicons',
                                showMenus: this.showIconMenus,
                                showColorPopover: this.showColorPopover
                            });
                        }
                    }
            
                    if (this.showAge > -1) {
                        this.plugins.push({ptype: 'rallycardage'});
                    }
                    
                    this.plugins.push({ptype:'tscardreleasealignment'});
                }
            });            
            Ext.define('Rally.technicalservices.plugin.ColumnHeaderUpdater', {
                alias: 'plugin.tscolumnheaderupdater',
                extend: 'Ext.AbstractPlugin',
            
                config: {
                    /**
                     * 
                     * @type {String} The name of the field holding the card's estimate
                     * 
                     * Defaults to c_FeatureEstimate (try LeafStoryPlanEstimateTotal)
                     */
                    field_to_aggregate: "c_FeatureEstimate",
                    
                    /**
                     * @property {Number} The current count of feature estimates
                     */
                    total_feature_estimate: 0,
            
                    /**
                     * @property {String|Ext.XTemplate} the header template to use 
                     */
                    headerTpl: new Rally.ui.renderer.template.progressbar.ProgressBarTemplate({
                        calculateColorFn: function(data) {
                            if ( data.percentDone > 0.9 ) {
                                return '#c00';
                            } 
                            return '#00c';
                        },
                        generateLabelTextFn: function(data) {
                            if ( data.percentDone === -1 ) {
                                return "No Planned Velocity";
                            } else {
                                if ( data.field_to_aggregate === "c_FeatureEstimate" ) {
                                    return 'By Feature: ' + this.calculatePercent(data) + '%';
                                } else {
                                    return 'By Story: ' + this.calculatePercent(data) + '%';
                                }
                            }
                        }
                    })
                    //headerTpl: '<div class="wipLimit">({total_feature_estimate} of {planned_velocity})</div>'
                },
            
                constructor: function(config) {
                    this.callParent(arguments);
                    if(Ext.isString(this.headerTpl)) {
                        this.headerTpl = Ext.create('Ext.XTemplate', this.headerTpl);
                    }
                    
                },
            
                init: function(column) {
                    this.column = column;
                    this.planned_velocity = this.column._planned_velocity;
                    
                    this.column.on('addcard', this.recalculate, this);
                    this.column.on('removecard', this.recalculate, this);
                    this.column.on('storeload', this.recalculate, this);
                    this.column.on('afterrender', this._afterRender, this);
                    this.column.on('ready', this.recalculate, this);
                    this.column.on('datachanged', this.recalculate, this);
            
                },
            
                destroy: function() {
                    if(this.column) {
                        delete this.column;
                    }
                },
            
                _afterRender: function() {
                    if ( this.feature_estimate_container ) {
                        this.feature_estimate_container.getEl().on('click', this._showPopover, this);
                    }
                },
                
                recalculate: function() {
                    this.total_feature_estimate = this.getTotalFeatureEstimate();
                    this.refresh();
                },
            
                refresh: function() {
                    
                    var me = this;
                    if (this.feature_estimate_container) {
                        this.feature_estimate_container.update(this.headerTpl.apply(this.getHeaderData()));
                    } else {
                        this.feature_estimate_container = Ext.widget({
                            xtype: 'container',
                            html: this.headerTpl.apply(this.getHeaderData())
                        });
                        
                        this.column.getColumnHeader().getHeaderTitle().add(this.feature_estimate_container);
                    }
                    
                    if ( this.feature_estimate_container ) {
                        this.feature_estimate_container.getEl().on('click', this._showPopover, this);
                    }
                },
            
                _showPopover: function() {
                    var me = this;
                    if ( me.planned_velocity > 0 ) {
                        if ( this.popover ) { this.popover.destroy(); }
                        this.popover = Ext.create('Rally.ui.popover.Popover',{
                            target: me.column.getColumnHeader().getHeaderTitle().getEl(),
                            items: [ me.getSummaryGrid() ]
                        });
                        
                        this.popover.show();
                    }
                },
                
                getSummaryGrid: function() {
                    var me = this;
                    var estimate_title = "Feature Estimates";
                    if ( this.field_to_aggregate !== "c_FeatureEstimate") {
                        estimate_title = "Story Estimates";
                    }
                    var store = Ext.create('Rally.data.custom.Store',{
                        data: [
                            {
                                'PlannedVelocity': me.planned_velocity,
                                'TotalEstimate': me.getTotalFeatureEstimate(),
                                'Remaining': me.getCapacity()
                            }
                        ]
                    });
                    var grid = Ext.create('Rally.ui.grid.Grid',{
                        store: store,
                        columnCfgs: [
                            { text: 'Release Plan', dataIndex:'PlannedVelocity' },
                            { text: estimate_title, dataIndex: 'TotalEstimate' },
                            { text: 'Remaining', dataIndex: 'Remaining' }
                        ],
                        showPagingToolbar: false
                    });
                    return grid;
                },
                
                getHeaderData: function() {
                    var total_feature_estimate = this.getTotalFeatureEstimate();
                    var percent_done = -1;
                    if ( this.planned_velocity > 0 ) {
                        percent_done = total_feature_estimate / this.planned_velocity;
                    }
                    return {
                        total_feature_estimate: total_feature_estimate,
                        planned_velocity: this.planned_velocity,
                        percentDone: percent_done,
                        field_to_aggregate: this.field_to_aggregate 
                    };
                },
                
                getCapacity: function() {
                    return this.planned_velocity - this.getTotalFeatureEstimate();
                },
                
                getTotalFeatureEstimate: function() {
                    var me = this;
                    var total = 0;
                    var total_unaligned = 0;
                    var records = this.column.getRecords();
                    Ext.Array.each(records, function(record){
                        var feature_estimate = record.get(me.field_to_aggregate) || 0;
                        var unaligned_estimate = record.get('UnalignedStoriesPlanEstimateTotal') || 0;
                        total += parseFloat(feature_estimate,10);
                        total_unaligned += parseFloat(unaligned_estimate,10);
                    });
                    
                    if ( me.field_to_aggregate !== "c_FeatureEstimate" ) {
                        total = total - total_unaligned;
                    }
                    return total;
                }
            
            });            Ext.define('Rally.ui.cardboard.plugin.ReleaseAlignment', {
                    extend: 'Ext.AbstractPlugin',
                    alias: 'plugin.tscardreleasealignment',
            
                    init: function(cmp) {
                        this.callParent(arguments);
                        this._addField();
                        
                        cmp.on('afterrender',this._addClickListener,this);
                    },
            
                    _addClickListener: function() {
                        this.cmp.getEl().on('click',this._showPopover,this);
                    },
                    
                    _showPopover: function() {
                        var me = this;
                        var count = this.cmp.record.get('UnalignedStories');
                        
                        if ( count > 0 ) {
                            if ( this.popover ) { this.popover.destroy(); }
                            this.popover = Ext.create('Rally.ui.popover.Popover',{
                                target: me.cmp.getEl(),
                                items: [ me._getPopoverContents() ]
                            });
                             
                            this.popover.show();
                        }
                    },
                    
                    _releaseGridRenderer: function(value) {
                        if ( value ) {
                            return value.Name;
                        } else {
                            return value;
                        }
                    },
                    
                    _getPopoverContents: function() {
                        var me = this;
                        var record = this.cmp.record;
                        var store = Ext.create('Rally.data.WsapiDataStore',{
                            model:'UserStory',
                            filters: [
                                {property:'Feature.ObjectID', value: record.get('ObjectID') },
                                {property:'DirectChildrenCount',value:0 }
                            ],
                            context: null,
                            autoLoad: true,
                            pageSize: 5
                        });
                        var grid = Ext.create('Rally.ui.grid.Grid',{
                            store: store,
                            
                            columnCfgs: [
                                {text:'id',dataIndex:'FormattedID'},
                                {text:'Name',dataIndex:'Name'},
                                {text:'Size',dataIndex:'PlanEstimate'},
                                {text:'Release',dataIndex:'Release',renderer: me._releaseGridRenderer},
                                {text:'State',dataIndex:'ScheduleState'}
                            ],
                            pagingToolbarCfg: {
                                 pageSizes: [5, 10, 25]
                            }
                            
                        });
                        
                        
                        return grid;
                    },
                    _addField: function() {
                        var me = this;
                        var record = this.cmp.getRecord();
                        var cmp = this.cmp;
                        
                        cmp.addField({
                            name: "Release",
                            renderTpl: function() {
                                me._findAlignment();
                                return [
                                    '<div id="' + record.get('FormattedID') + '-releasealignment">',
                                        '',
                                    '</div>'
                                ].join('');
                                
                            },
                            isStatus: false
                        });
                    },
            
                    //TODO: stop calling it a feature
                    _findAlignment: function() {
                        var me = this;
                        var feature = this.cmp.getRecord();
                        
                        var release = feature.get('Release');
                        var feature_fid = feature.get('FormattedID');
                        
                        if ( release ) {
                            var filters = [
                                {property:'Feature.FormattedID',value: feature_fid},
                                {property:'Release.Name',operator:'!=',value:release.Name},
                                {property:'DirectChildrenCount',value:0}
                            ];
                            Ext.create('Rally.data.WsapiDataStore',{
                                autoLoad: true,
                                model:'UserStory',
                                filters:filters,
                                listeners: {
                                    load: function(store,records,operation) {
                                        var html = "";
                                        var out_of_sync_total = 0;
                                        if ( records.length > 0 ) {
                                            html = "<span class='status-warn'>" + records.length + "</span>";
                                        } 
                                        Ext.query('#' + feature_fid + '-releasealignment')[0].innerHTML = html;
                                        
                                        Ext.Array.each( records, function(record) {
                                            var estimate = record.get('PlanEstimate') || 0;
                                            out_of_sync_total += parseFloat(estimate,10);
                                        });
                                        me.cmp.record.set('UnalignedStories',records.length);
                                        me.cmp.record.set('UnalignedStoriesPlanEstimateTotal',out_of_sync_total);
                                        me.cmp.fireEvent('datachanged', me.cmp, records, operation);
                                    }
                                }
                            });
                        }
                        return true;
                    }
                });            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                logger: new Rally.technicalservices.logger(),
                launch: function() {
                    var me = this;
                    this.cardboard = Ext.create('Rally.ui.cardboard.CardBoard',{
                        types: ['PortfolioItem/Feature'],
                        attribute: 'Release',
                        columnConfig: {
                            xtype: 'rallycardboardcolumn',
                            displayField: 'Name',
                            valueField: '_ref',
                            plugins: [
                                {ptype:'rallycolumndropcontroller'},
                                {ptype:'rallycardboardcardrecordprocessor'},
                                {ptype:'tscolumnheaderupdater'}  /*,
                                {ptype:'tscolumnheaderupdater', field_to_aggregate: 'LeafStoryPlanEstimateTotal'}*/
                            ]
                        },
                        storeConfig:{ },
                        cardConfig: {
                            showIconsAndHighlightBorder: false,
                            
                            fields: [
                                'FormattedID',
                                'Name',
                                { name: 'c_FeatureEstimate', fetch: ['c_FeatureEstimate'] }
                            ],
                            listeners: {
                                added: function(card,container){
                                    me.logger.log(this,card,container);
                                }
                            }
                        }
                    });
                    this.add(this.cardboard);
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'Feature Planning Board'
            });
        });
    </script>

    <style type="text/css">
        .progress-bar-label {
            color: white;
            font-size: 75%;
        }
        
        .field-percentDone {
            margin: 2px;
            background-color: #ccc;
        }
        
        .status-field {
            background-color: #fff;
        }
        
        .status-warn {
            background-color: #c00;
            color: #fff;
            padding: 3px;
        }    </style>
</head>
<body></body>
</html>
