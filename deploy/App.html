<!DOCTYPE html>
<html>
<head>
    <title>Feature Planning Board</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            /*
             */
            Ext.define('Rally.technicalservices.logger',{
                constructor: function(config){
                    Ext.apply(this,config);
                },
                log: function(args){
                    var output_args = [];
                    if (arguments.length === 0 ) {
                        window.console && console.log(arguments);
                        return;
                    }
                    if (arguments.length === 1 ) {
                        output_args = arguments;
                    } else {
                        var src_class = arguments[0];
                        var class_name = "";
                        if ( typeof(src_class) === "string" ) {
                            class_name = src_class;
                        } else if ( typeof src_class.getName === "function") { 
                            class_name = src_class.getName();
                        } else if (typeof src_class.self.getName === 'function'){
                            class_name = src_class.self.getName();
                        }
                        //window.console && console.log(class_name,"--",message);
                        output_args = Ext.Array.push(output_args,[class_name,"--"]);
                        output_args = Ext.Array.push(output_args,Ext.Array.slice(arguments,1));
                    }
                    window.console && console.log.apply(console,output_args);
                }
            
            });            /*
             * Modify the building of columns based on release instead of a string drop-down
             */
            
            Ext.override(Rally.ui.cardboard.CardBoard,{
            
                _buildColumnsFromModel: function() {
                    var me = this;
                    var model = this.models[0];
                    if (model) {
                        if ( this.attribute === "Release" ) { 
                            var retrievedColumns = [];
                            retrievedColumns.push({
                                
                                value: null,
                                columnHeaderConfig: {
                                    headerTpl: "{name}",
                                    headerData: {
                                        name: "Backlog"
                                    }
                                }
                            });
            
                            this._getLocalReleases(retrievedColumns);
                        }
                    }
                },
                _getLocalReleases: function(retrievedColumns) {
                    var me = this;
                                    
                    var today_iso = Rally.util.DateTime.toIsoString(new Date(),false);
                    var filters = [{property:'ReleaseDate',operator:'>',value:today_iso}];
                    
                    var iteration_names = [];
                    
                    Ext.create('Rally.data.WsapiDataStore',{
                        model:me.attribute,
                        autoLoad: true,
                        filters: filters,
                        context: { projectScopeUp: false, projectScopeDown: false },
                        sorters: [
                            {
                                property: 'ReleaseDate',
                                direction: 'ASC'
                            }
                        ],
                        limit: 3,
                        pageSize: 3,
                        fetch: ['Name','ReleaseStartDate','ReleaseDate','PlannedVelocity'],
                        listeners: {
                            load: function(store,records) {
                                Ext.Array.each(records, function(record){
                                    var start_date = Rally.util.DateTime.formatWithNoYearWithDefault(record.get('ReleaseStartDate'));
                                    var end_date = Rally.util.DateTime.formatWithNoYearWithDefault(record.get('ReleaseDate'));
                                    iteration_names.push(record.get('Name'));
                                    
                                    retrievedColumns.push({
                                        value: record,
                                        _planned_velocity: 0,
                                        _missing_estimate: false,
                                        columnHeaderConfig: {
                                            headerTpl: "{name}<br/>{start_date} - {end_date}",
                                            headerData: {
                                                name: record.get('Name'),
                                                start_date: start_date,
                                                end_date: end_date,
                                                planned_velocity: 0,
                                                missing_estimate: false
                                            }
                                        }
                                    });
                                });
                                this._getAllReleases(retrievedColumns,iteration_names);
                            },
                            scope: this
                        }
                    });
                },
                _getAllReleases: function(retrievedColumns,iteration_names) {
                    var me = this;
                                    
                    var today_iso = Rally.util.DateTime.toIsoString(new Date(),false);
                    var filters = [{property:'ReleaseDate',operator:'>',value:today_iso}];
            
                    Ext.create('Rally.data.WsapiDataStore',{
                        model:me.attribute,
                        autoLoad: true,
                        filters: filters,
                        sorters: [
                            {
                                property: 'ReleaseDate',
                                direction: 'ASC'
                            }
                        ],
                        fetch: ['Name','Project','PlannedVelocity'],
                        listeners: {
                            load: function(store,records) {
                                Ext.Array.each(records, function(record){
                                    var planned_velocity = record.get('PlannedVelocity') || 0;
                                    
                                    var index = Ext.Array.indexOf(iteration_names,record.get('Name'));
                                    if (planned_velocity == 0 ) {
                                        retrievedColumns[index+1]._missing_estimate = true;
                                    }
                                    retrievedColumns[index+1]._planned_velocity += planned_velocity;
                                });
                                this.fireEvent('columnsretrieved',this,retrievedColumns);
                                this.columnDefinitions = [];
                                _.map(retrievedColumns,this.addColumn,this);
                                this._renderColumns();
                            },
                            scope: this
                        }
                    });
                }
            });
            
            Ext.override(Rally.ui.cardboard.Card,{
                _setupPlugins: function() {
                    var cardContentRightPlugin = {ptype: 'rallycardcontentright'};
            
                    this.plugins.push(cardContentRightPlugin);
                    this.plugins.push({ptype: 'rallycardcontentleft'});
            
                    if (this.record.get('updatable')) {
                        if (this.editable) {
                            this.addCls('editable');
                            this.plugins.push({ptype: 'rallycardediting'});
            
                            var predicateFn = Rally.predicate.RecordPredicates.hasField('PlanEstimate');
                            if (predicateFn(this.record) && Ext.Array.contains(this.getFields(), 'PlanEstimate')) {
                                cardContentRightPlugin.showPlanEstimate = true;
                            }
            
                            if (this.enableValidationUi) {
                                this.plugins.push({ptype: 'rallycardvalidation'});
                                this.plugins.push({ptype: 'rallycardvalidationui', notificationFieldNames: ['PlanEstimate']});
                            }
                        }
            
                        if (this.showIconsAndHighlightBorder) {
                            this.plugins.push({
                                ptype: 'rallycardicons',
                                showMenus: this.showIconMenus,
                                showColorPopover: this.showColorPopover
                            });
                        }
                    }
            
                    if (this.showAge > -1) {
                        this.plugins.push({ptype: 'rallycardage'});
                    }
                    
                    this.plugins.push({ptype:'tscardreleasealignment'});
                }
            });
            
            Ext.override(Rally.ui.cardboard.Column,{
                getStoreFilter: function(model) {
                    var property = this.attribute;
                    var value = this.getValue();
                    if ( this.attribute == "Release" ) {
                        property = "Release.Name";
                        if ( value ) {
                            value = value.get('Name');
                        }
                    }
                    return {
                        property:property,
                        operator: '=',
                        value: value
                    };
                },
                isMatchingRecord: function(record) {
                    var recordValue = record.get(this.attribute);
                    if (recordValue) {
                        recordValue = recordValue.Name;
                    }
                    var columnValue = this.getValue();
                    if ( columnValue ) {
                        columnValue = columnValue.get('Name');
                    }
                    
                    return (columnValue === recordValue );
                },
                addCard: function(card, index, highlight) {
                    var record = card.getRecord();
                    var target_value = this.getValue();
                    
                    if ( target_value && typeof(target_value.get) === "function" ) {
                        target_value = this.getValue().get('_ref');
                    }
                    
                    record.set(this.attribute,target_value);
                    
                    if (!Ext.isNumber(index)) {
                        //find where it should go
                        var records = Ext.clone(this.getRecords());
                        records.push(record);
                        this._sortRecords(records);
            
                        var recordIndex = 0;
                        for (var iIndex = 0, l = records.length; iIndex < l; iIndex++) {
                            var i = records[iIndex];
                            if (i.get("ObjectID") === record.get("ObjectID")) {
                                recordIndex = iIndex;
                                break;
                            }
                        }
                        index = recordIndex;
                    }
            
                    this._renderCard(card, index);
            
                    if (highlight) {
                        card.highlight();
                    }
            
                    this.fireEvent('addcard');
                    card.fireEvent('ready', card);
                },
                _sortRecords: function(records) {
                        var sortProperty = this._getSortProperty(),
                            sortAscending = this._getSortDirection() === 'ASC',
                            valA, valB;
            
                            // force to new rank style
                            sortProperty = "DragAndDropRank";
            
                        records.sort(function(a, b) {
                            valA = a.get(sortProperty);
                            if (valA && valA._refObjectName) {
                                valA = valA._refObjectName;
                            }
                            valB = b.get(sortProperty);
                            if (valB && valB._refObjectName) {
                                valB = valB._refObjectName;
                            }
            
                            if (valA === valB) {
                                return 0;
                            }
            
                            if (valA !== null && valA !== undefined) {
                                if (valB === null || valB === undefined) {
                                    return sortAscending ? -1 : 1;
                                } else {
                                    return valA > valB ? (sortAscending ? 1 : -1) : (sortAscending ? -1 : 1);
                                }
                            } else if (valB !== null && valB !== undefined) {
                                if (valA === null || valA === undefined) {
                                    return sortAscending ? 1 : -1;
                                } else {
                                    return valB > valA ? (sortAscending ? -1 : 1) : (sortAscending ? 1 : -1);
                                }
                            }
            
                            //Default case (dates, objects, etc.)
                            return sortAscending ? valA - valB : valB - valA;
                        });
                    }
            });
            
            /**
             * fix a bug in the rc1 popover where a complete item checked
             * its actual end against planned end
             */
            Ext.override(Rally.ui.popover.PercentDonePopover,{
                getActualEndDateTpl: function() {
                    var formatDateFn = Ext.bind(this._formatDate,this);
                    return Ext.create('Ext.XTemplate',
                        '<hr/>',
                        '<h3>ACTUAL END DATE</h3>',
                        '<div class="actualEndDateInfo percentDoneLine">',
                            '{[this.formatDate(values.ActualEndDate)]}',
                            '<tpl if="PlannedEndDate">',
                                ' ({[this.getEstimateMessage(values)]})',
                            '</tpl></div>', {
                        getEstimateMessage: function(values) {
                            var message;
                
                            // fix bug from rc1 code
            //                var actualEnd = formatDateFn(values.ActualEndDate);
            //                var plannedEnd = formatDateFn(values.PlannedEndDate);
                            var actualEnd = values.ActualEndDate;
                            var plannedEnd = values.PlannedEndDate;
                                
                            var diff = Rally.util.DateTime.getDifference(plannedEnd, actualEnd, 'day');
            
                            if (diff === 0) {
                                message = 'on time';
                            } else if (diff > 0) {
                                message = diff + ' day' + (diff === 1 ? '' : 's') + ' early';
                            } else {
                                diff = Math.abs(diff);
                                message = diff + ' day' + (diff === 1 ? '' : 's') + ' late';
                            }
                
                            return message;
                        },
                        formatDate: Ext.bind(this._formatDate,this)
                    });
                }
            });            Ext.define('Rally.technicalservices.template.LabeledProgressBarTemplate',{
                extend: 'Ext.XTemplate',
                config: {
                    /**
                     * 
                     * @type {String} label to display above the bar
                     */
                    fieldLabel: '',
                    /**
                     * @cfg {String} width define a width if necessary to fit where it's being used
                     */
                    width: '100%',
                    /**
                     * @cfg {String} height define a height if necessary to fit where it's being used
                     */
                    height: '20px',
                    /**
                     * @cfg {String} percentDoneName sometimes it's necessary to name the variable used as the percent done replacement in the template,
                     * like in a grid when a record is used to render the template. The record's field name might be 'PercentDoneByStoryCount', not 'percentDone'
                     */
                    percentDoneName: 'percentDone',
                    /**
                     * @cfg {Function} showDangerNotificationFn A function that should return true to show a triangle in the top right to denote something is missing.
                     * Defaults to:
                     *      function(){ return false; }
                     */
                    showDangerNotificationFn: function() {
                        return false;
                    },
            
                    /**
                     * @cfg {Function} (required)
                     * A function that returns the color for the percent done bar in hex
                     */
                    calculateColorFn: Ext.emptyFn,
            
                    /**
                     * @cfg {Boolean} If the percent done is 0%, do not show the bar at all
                     */
                    showOnlyIfInProgress: false,
            
                    /**
                     * @cfg {Function}
                     * A function that returns the text to show in the progress bar.
                     * Defaults to a function that returns the percentage complete.
                     */
                    generateLabelTextFn: function (recordData) {
                        return this.calculatePercent(recordData) + '%';
                    }
                },
                constructor: function(config) {
                    this.initConfig(config);
                    config = this.config;
                    var templateConfig = [
                        '<tpl if="this.shouldShowPercentDone(values)">',
                            '<div class="progress-bar-fieldlabel">{[this.fieldLabel]}</div>',
                            '<div class="progress-bar-container field-{[this.getPercentDoneName()]} {[this.getClickableClass()]}" style="{[this.getDimensionStyle()]}">',
                                '<div class="progress-bar" style="background-color: {[this.calculateColor(values)]}; width: {[this.calculateWidth(values)]}; "></div>',
                                '<tpl if="this.showDangerNotification(values)">',
                                    '<div class="progress-bar-danger-notification"></div>',
                                '</tpl>',
                                '<div class="progress-bar-label">',
                                    '{[this.generateLabelText(values)]}',
                                '</div>',
                            '</div>',
                        '</tpl>',
                        {
                            shouldShowPercentDone: function(recordData) {
                                var value = recordData[config.percentDoneName];
                                if(!Ext.isNumber(value)){
                                    return false;
                                }
            
                                if (config.showOnlyIfInProgress) {
                                    return value > 0;
                                } else {
                                    return true;
                                }
                            },
                            getClickableClass: function(){
                                return config.isClickable ? 'clickable' : '';
                            },
                            getDimensionStyle: function(){
                                return 'width: ' + config.width + '; height: ' + config.height + '; line-height: ' + config.height;
                            },
                            calculateWidth: function (recordData) {
                                var percentDone = this.calculatePercent(recordData);
                                return percentDone > 100 ? '100%' : percentDone + '%';
                            },
                            calculatePercent: function (recordData) {
                                var percentDone = recordData[config.percentDoneName];
                                return Math.round(percentDone * 100);
                            },
                            generateLabelText: config.generateLabelTextFn,
                            calculateColor: config.calculateColorFn,
                            showDangerNotification: config.showDangerNotificationFn
                        }];
                    /**
                     * @param {Date}  config.startDate  (days since the epoch or date type where Tomorrow()-Today() = 1.0 (real))
                     * @param {Date} config.endDate (same type as startDate)
                     * @param {Date} config.asOfDate (same type as startDate) - Most often today. The naming of
                     * @param {Boolean} config.inProgress
                     */
                    return this.callParent(templateConfig);
            
                }
            });            
            Ext.define('Rally.technicalservices.plugin.ColumnHeaderUpdater', {
                alias: 'plugin.tscolumnheaderupdater',
                extend: 'Ext.AbstractPlugin',
            
                config: {
                    /**
                     * 
                     * @type {String} The name of the field holding the card's estimate
                     * 
                     * Defaults to c_FeatureEstimate (try LeafStoryPlanEstimateTotal)
                     */
                    field_to_aggregate: "c_FeatureEstimate",
                    
                    /**
                     * @property {Number} The current count of feature estimates
                     */
                    total_feature_estimate: 0,
            
                    /**
                     * @property {String|Ext.XTemplate} the header template to use 
                     */
                    headerTpl: new Rally.technicalservices.template.LabeledProgressBarTemplate({
                        fieldLabel: 'Features Planned vs Planned Velocity: ',
                        calculateColorFn: function(data) {
                            if ( data.percentDone > 0.9 ) {
                                return '#EDB5B1';
                            } 
                            return '#99CCFF';
                        },
                        showDangerNotificationFn: function(data) {
                            return data.missing_estimate;
                        },
                        generateLabelTextFn: function(data) {
                            if ( data.percentDone === -1 ) {
                                return "No Planned Velocity";
                            } else {
                                var text_string = "";
                                if ( data.field_to_aggregate === "c_FeatureEstimate" ) {
                                    text_string = this.calculatePercent(data) + '%';
                                } else {
                                    text_string = 'By Story: ' + this.calculatePercent(data) + '%';
                                }
                                
                                return text_string;
                            }
                        }
                    })
                    //headerTpl: '<div class="wipLimit">({total_feature_estimate} of {planned_velocity})</div>'
                },
            
                constructor: function(config) {
                    this.callParent(arguments);
                    if(Ext.isString(this.headerTpl)) {
                        this.headerTpl = Ext.create('Ext.XTemplate', this.headerTpl);
                    }
                    
                },
            
                init: function(column) {
                    this.column = column;
            
                    if ( column.value === null ) {
                        this.headerTpl = new Ext.XTemplate('');
                    }
                    this.planned_velocity = this.column._planned_velocity;
                    this.missing_estimate = this.column._missing_estimate;
                    
                    this.column.on('addcard', this.recalculate, this);
                    this.column.on('removecard', this.recalculate, this);
                    this.column.on('storeload', this.recalculate, this);
                    this.column.on('afterrender', this._afterRender, this);
                    this.column.on('ready', this.recalculate, this);
                    this.column.on('datachanged', this.recalculate, this);
            
                },
            
                destroy: function() {
                    if(this.column) {
                        delete this.column;
                    }
                },
            
                _afterRender: function() {
                    if ( this.feature_estimate_container ) {
                        this.feature_estimate_container.getEl().on('click', this._showPopover, this);
                    }
                },
                
                recalculate: function() {
                    this.total_feature_estimate = this.getTotalFeatureEstimate();
                    this.refresh();
                },
            
                refresh: function() {
                    console.log(this.getHeaderData());
                    var me = this;
                    if (this.feature_estimate_container) {
                        this.feature_estimate_container.update(this.headerTpl.apply(this.getHeaderData()));
                    } else {
                        this.feature_estimate_container = Ext.widget({
                            xtype: 'container',
                            html: this.headerTpl.apply(this.getHeaderData())
                        });
                        
                        this.column.getColumnHeader().getHeaderTitle().add(this.feature_estimate_container);
                    }
                    
                    if ( this.feature_estimate_container ) {
                        this.feature_estimate_container.getEl().on('click', this._showPopover, this);
                    }
                },
            
                _showPopover: function() {
                    var me = this;
                    if ( me.planned_velocity > 0 ) {
                        if ( this.popover ) { this.popover.destroy(); }
                        this.popover = Ext.create('Rally.ui.popover.Popover',{
                            target: me.column.getColumnHeader().getHeaderTitle().getEl(),
                            items: [ me.getSummaryGrid() ]
                        });
                        
                        this.popover.show();
                    }
                },
                
                getSummaryGrid: function() {
                    var me = this;
                    var estimate_title = "Feature Estimates";
                    if ( this.field_to_aggregate !== "c_FeatureEstimate") {
                        estimate_title = "Story Estimates";
                    }
                    var store = Ext.create('Rally.data.custom.Store',{
                        data: [
                            {
                                'PlannedVelocity': me.planned_velocity,
                                'TotalEstimate': me.getTotalFeatureEstimate(),
                                'Remaining': me.getCapacity(),
                                'MissingEstimate': me.missing_estimate
                            }
                        ]
                    });
                    var grid = Ext.create('Rally.ui.grid.Grid',{
                        store: store,
                        columnCfgs: [
                            { text: 'Release Plan', dataIndex:'PlannedVelocity' },
                            { text: estimate_title, dataIndex: 'TotalEstimate' },
                            { text: 'Remaining', dataIndex: 'Remaining' },
                            { text: 'Team Missing Plan?', dataIndex: 'MissingEstimate' }
                        ],
                        showPagingToolbar: false
                    });
                    return grid;
                },
                
                getHeaderData: function() {
                    var total_feature_estimate = this.getTotalFeatureEstimate();
                    var percent_done = -1;
                    if ( this.planned_velocity > 0 ) {
                        percent_done = total_feature_estimate / this.planned_velocity;
                    }
                    return {
                        total_feature_estimate: total_feature_estimate,
                        planned_velocity: this.planned_velocity,
                        percentDone: percent_done,
                        field_to_aggregate: this.field_to_aggregate,
                        missing_estimate: this.missing_estimate
                    };
                },
                
                getCapacity: function() {
                    return this.planned_velocity - this.getTotalFeatureEstimate();
                },
                
                getTotalFeatureEstimate: function() {
                    var me = this;
                    var total = 0;
                    var total_unaligned = 0;
                    var records = this.column.getRecords();
                    Ext.Array.each(records, function(record){
                        var feature_estimate = record.get(me.field_to_aggregate) || 0;
                        var unaligned_estimate = record.get('UnalignedStoriesPlanEstimateTotal') || 0;
                        total += parseFloat(feature_estimate,10);
                        total_unaligned += parseFloat(unaligned_estimate,10);
                    });
                    
                    if ( me.field_to_aggregate !== "c_FeatureEstimate" ) {
                        total = total - total_unaligned;
                    }
                    return total;
                }
            
            });            Ext.define('Rally.ui.cardboard.plugin.ReleaseAlignment', {
                    extend: 'Ext.AbstractPlugin',
                    alias: 'plugin.tscardreleasealignment',
            
                    init: function(cmp) {
                        this.callParent(arguments);
                        this._addField();
                    },
            
                    _addAlignmentClickListener: function() {
                        var element_id = this.cmp.record.get('FormattedID') + '-releasealignment';
                        var marker = Ext.query('#'+element_id);
                        if ( marker.length > 0 ){
                            Ext.get(marker[0]).on('click',this._showPopover,this);
                        }
                    },
                    
                    _showPopover: function() {
                        var me = this;
                        var count = this.cmp.record.get('UnalignedStories');
                        
                        if ( count > 0 ) {
                            if ( this.popover ) { this.popover.destroy(); }
                            this.popover = Ext.create('Rally.ui.popover.Popover',{
                                target: me.cmp.getEl(),
                                items: [ me._getPopoverContents() ]
                            });
                             
                            this.popover.show();
                        }
                    },
                    
                    _releaseGridRenderer: function(value) {
                        if ( value && typeof( value ) == "object" ) {
                            return value._refObjectName;
                        } else {
                            return value;
                        }
                    },
                    
                    _storyLinkRenderer: function(value,meta,record) {
                        return Rally.nav.DetailLink.getLink({
                            showHover: false,
                            record:record.getData(),
                            text:record.get("FormattedID")
                        });
                    },
                    
                    _getPopoverContents: function() {
                        var me = this;
                        var record = this.cmp.record;
                        var store = Ext.create('Rally.data.WsapiDataStore',{
                            model:'UserStory',
                            filters: [
                                {property:'Feature.ObjectID', value: record.get('ObjectID') },
                                {property:'DirectChildrenCount',value:0 }
                            ],
                            context: null,
                            autoLoad: true,
                            pageSize: 5
                        });
                        var grid = Ext.create('Rally.ui.grid.Grid',{
                            store: store,
                            
                            columnCfgs: [
                                {text:'id',dataIndex:'FormattedID',renderer: me._storyLinkRenderer},
                                {text:'Name',dataIndex:'Name'},
                                {text:'Size',dataIndex:'PlanEstimate'},
                                {text:'Release',dataIndex:'Release',renderer: me._releaseGridRenderer,editor:'rallyreleasecombobox'},
                                {text:'State',dataIndex:'ScheduleState'}
                            ],
                            pagingToolbarCfg: {
                                 pageSizes: [5, 10, 25]
                            }
                            
                        });
                        
                        
                        return grid;
                    },
                    _addField: function() {
                        var me = this;
                        var record = this.cmp.getRecord();
                        var cmp = this.cmp;
                        
                        cmp.addField({
                            name: "Release",
                            renderTpl: function() {
                                me._findAlignment();
                                return [
                                    '<div id="' + record.get('FormattedID') + '-releasealignment">',
                                        '',
                                    '</div>'
                                ].join('');
                                
                            },
                            isStatus: false
                        });
                    },
            
                    //TODO: stop calling it a feature
                    _findAlignment: function() {
                        var me = this;
                        var feature = this.cmp.getRecord();
                        
                        var release = feature.get('Release');
                        var feature_fid = feature.get('FormattedID');
                        
                        if ( release ) {
                            var filters = [
                                {property:'Feature.FormattedID',value: feature_fid},
                                {property:'Release.Name',operator:'!=',value:release.Name},
                                {property:'DirectChildrenCount',value:0}
                            ];
                            Ext.create('Rally.data.WsapiDataStore',{
                                autoLoad: true,
                                model:'UserStory',
                                filters:filters,
                                listeners: {
                                    load: function(store,records,operation) {
                                        var html = "";
                                        var out_of_sync_total = 0;
                                        if ( records.length > 0 ) {
                                            html = "# User Stories Not in Release: <span class='status-warn'>" + records.length + "</span>";
                                        } 
                                        Ext.query('#' + feature_fid + '-releasealignment')[0].innerHTML = html;
                                        
                                        Ext.Array.each( records, function(record) {
                                            var estimate = record.get('PlanEstimate') || 0;
                                            out_of_sync_total += parseFloat(estimate,10);
                                        });
                                        me.cmp.record.set('UnalignedStories',records.length);
                                        me.cmp.record.set('UnalignedStoriesPlanEstimateTotal',out_of_sync_total);
                                        me.cmp.fireEvent('datachanged', me.cmp, records, operation);
                                        me._addAlignmentClickListener();
                                    }
                                }
                            });
                        }
                        return true;
                    }
                });            Ext.define('CustomApp', {
                extend: 'Rally.app.App',
                componentCls: 'app',
                logger: new Rally.technicalservices.logger(),
                launch: function() {
                    var me = this;
                    this.cardboard = Ext.create('Rally.ui.cardboard.CardBoard',{
                        types: ['PortfolioItem/Feature'],
                        attribute: 'Release',
                        columnConfig: {
                            xtype: 'rallycardboardcolumn',
                            displayField: 'Name',
                            valueField: '_ref',
                            plugins: [
                                {ptype:'rallycolumndropcontroller'},
                                {ptype:'rallycardboardcardrecordprocessor'},
                                {ptype:'tscolumnheaderupdater'}  /*,
                                {ptype:'tscolumnheaderupdater', field_to_aggregate: 'LeafStoryPlanEstimateTotal'}*/
                            ]
                        },
                        storeConfig:{ },
                        cardConfig: {
                            showIconsAndHighlightBorder: false,
                            
                            fields: [
                                'FormattedID',
                                'Name',
                                { name: 'Project', renderer: me._renderProject },
                                'State',
                                { name: 'PercentDoneByStoryPlanEstimate' },
                                { name: 'c_FeatureEstimate', fetch: ['c_FeatureEstimate'] }
                            ],
                            listeners: {
                                added: function(card,container){
                                    me.logger.log(this,card,container);
                                },
                                fieldClick: function(eOpts) {
                                    me.logger.log(this,eOpts);
                                    if ( eOpts == "PercentDoneByStoryPlanEstimate" ) {
                                        me._showDoneTooltip(eOpts,this);
                                    }
                                }
                            }
                        }
                    });
                    
                    this.add(this.cardboard);
                    
                },
                _showDoneTooltip:function(field_name,card) {
                    var me = this;
                    var record = card.getRecord();
                    var progress = card.getEl().down('.progress-bar-container');
                    me.logger.log("record", record.data);
                    
                    Ext.create('Rally.ui.popover.PercentDonePopover', {
                        target: progress,
                        percentDoneData: record.data,
                        percentDoneName: field_name,
                        piRef: record.data._ref
                    });
                },
                _renderProject: function(value) {
                    return value.get('Name');
                }
            });

            Rally.launchApp('CustomApp', {
                name: 'Feature Planning Board'
            });
        });
    </script>

    <style type="text/css">
        .progress-bar-label {
            color: white;
            font-size: 75%;
        }
        
        .field-percentDone {
            margin: 2px;
            background-color: #ccc;
        }
        
        .status-field {
            background-color: #fff;
        }
        
        .status-warn {
            background-color: #c00;
            color: #fff;
            padding: 3px;
        }
        
        .progress-bar-fieldlabel {
            font-size: 10px;
            color: #808080;
        }    </style>
</head>
<body></body>
</html>
